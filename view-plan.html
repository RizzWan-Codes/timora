<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Timora — Shared Study Plan</title>

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #7452ff;
      --primary2: #c96bff;
      --bg1: #f0e9ff;
      --bg2: #e1f4ff;
      --text-dark: #0f172a;
      --text-light: #64748b;
      --glass: rgba(255, 255, 255, 0.55);
      --glass-border: rgba(255, 255, 255, 0.28);
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(145deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* HEADER */
    header {
      width: 100%;
      padding: 26px 0;
      background: rgba(255, 255, 255, 0.55);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid var(--glass-border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      text-align: center;
    }

    header h1 {
      font-size: 28px;
      font-weight: 800;
      color: var(--primary);
      letter-spacing: -0.5px;
    }

    /* INFO CARD (User + Date) */
    #infoCard {
      margin-top: 30px;
      padding: 22px 26px;
      width: 92%;
      max-width: 900px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-radius: 18px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 20px 50px rgba(0,0,0,0.12);
      display: none;
    }

    #infoCard h2 {
      font-size: 22px;
      margin: 0 0 10px 0;
      color: var(--text-dark);
      font-weight: 700;
    }

    #infoCard p {
      margin: 4px 0;
      color: var(--text-light);
      font-size: 15px;
    }

    /* PDF VIEWER */
    #viewerContainer {
      margin-top: 28px;
      margin-bottom: 50px;
      width: 92%;
      max-width: 900px;
      padding: 18px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      backdrop-filter: blur(20px);
      box-shadow: 0 22px 60px rgba(0,0,0,0.15);
      display: none;
    }

    #viewer {
      width: 100%;
      height: 88vh;
      border: none;
      border-radius: 14px;
      background: white;
    }

    /* LOADING */
    #loading {
      margin-top: 120px;
      font-size: 20px;
      font-weight: 500;
      padding: 20px 30px;
      background: var(--glass);
      border-radius: 14px;
      border: 1px solid var(--glass-border);
      color: var(--text-light);
      backdrop-filter: blur(18px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.1);
    }

    /* FOOTER */
    footer {
      margin: 40px 0 20px;
      color: var(--text-light);
      font-size: 14px;
      text-align: center;
    }
  </style>
</head>

<body>

<header>
  <h1>Timora — Shared Plan</h1>
</header>

<div id="loading">Fetching shared study plan…</div>

<!-- USER INFO CARD -->
<div id="infoCard">
  <h2 id="ownerName">Plan by — Unknown User</h2>
  <p id="createdDate">Created on: --</p>
  <p style="margin-top:8px; font-size:14px;">Shared securely via Timora AI Planner</p>
</div>

<!-- PDF VIEWER -->
<div id="viewerContainer">
  <iframe id="viewer"></iframe>
</div>

<footer>
  Crafted with ❤️ by Timora • Stay disciplined.
</footer>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsZ2luMQAqmnwk0y6-vJ1gzKkMd1NKFuc",
    authDomain: "timora-2680a.firebaseapp.com",
    projectId: "timora-2680a",
    storageBucket: "timora-2680a.firebasestorage.app",
    messagingSenderId: "1036436572315",
    appId: "1:1036436572315:web:58b1ecb4cb84045aaa5e3e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Get ?id=
  const id = new URLSearchParams(window.location.search).get("id");

  if (!id) {
    document.getElementById("loading").innerText = "Invalid or missing share link.";
    throw new Error("Missing ID");
  }

  async function loadPDF() {
    const snap = await getDoc(doc(db, "shared-plans", id));

    if (!snap.exists()) {
      document.getElementById("loading").innerText = "This shared plan has expired or does not exist.";
      return;
    }

    const data = snap.data();

    /* --- UPDATE USER INFO CARD --- */
    document.getElementById("ownerName").innerText =
      "Plan by — " + (data.userName || "Anonymous User");

    const date = new Date(data.createdAt).toLocaleString();
    document.getElementById("createdDate").innerText = "Created on: " + date;

    document.getElementById("infoCard").style.display = "block";

    /* --- BASE64 → PDF --- */
    const base64 = (data.pdfData || "").split(",")[1];
    const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
    const blob = new Blob([bytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const viewer = document.getElementById("viewer");
    viewer.src = url;

    document.getElementById("viewerContainer").style.display = "block";
    document.getElementById("loading").remove();
  }

  loadPDF();
</script>

</body>
</html>
