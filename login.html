<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Timora ‚Äî Login</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #8b5cf6;
      --secondary: #ec4899;
      --accent: #06b6d4;
    }
    body { font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .orb {
      position: absolute;
      border-radius: 9999px;
      filter: blur(80px);
      opacity: 0.45;
      transform: translate3d(0,0,0);
      z-index: 0;
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
      50% { box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); }
    }
    
    .referral-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-800 flex items-center justify-center p-6">

  <!-- Floating gradient orbs -->
  <div class="orb" style="width:380px;height:380px;background:linear-gradient(135deg,var(--primary),var(--secondary)); top:-120px; left:-120px;"></div>
  <div class="orb" style="width:460px;height:460px;background:linear-gradient(135deg,var(--secondary),#06b6d4); bottom:-160px; right:-160px; opacity:0.35;"></div>
  <div class="orb" style="width:300px;height:300px;background:linear-gradient(135deg,var(--primary),#60a5fa); top:45%; left:50%; transform:translate(-30%, -40%); opacity:0.18;"></div>

  <!-- Main card -->
  <div class="relative z-10 w-full max-w-lg">
    <!-- Logo + heading -->
    <div class="mb-8 text-center">
      <a href="/" class="inline-flex items-center gap-3">
        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-[rgba(139,92,246,1)] to-[rgba(236,72,153,1)] flex items-center justify-center shadow-lg">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 7.5L12 3l9 4.5v9L12 21 3 16.5v-9z" fill="white" opacity="0.95"/>
            <path d="M12 3v18" stroke="white" stroke-opacity="0.08" stroke-width="1.5"/>
          </svg>
        </div>
        <span class="text-2xl font-semibold tracking-tight">Timora</span>
      </a>
      <p class="mt-2 text-sm text-slate-500">Plan smarter. Study better.</p>
    </div>

    <!-- Referral Banner (shown when ref code exists) -->
    <div id="referralBanner" class="hidden mb-6 p-4 rounded-2xl bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 referral-glow">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center text-2xl flex-shrink-0">
          üéÅ
        </div>
        <div class="flex-1">
          <div class="font-semibold text-emerald-800">You've been invited!</div>
          <div class="text-sm text-emerald-600">Sign up to receive <span id="bonusAmount" class="font-bold">50</span> bonus coins</div>
        </div>
        <div class="text-emerald-500">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Card -->
    <div class="bg-white/80 backdrop-blur rounded-3xl shadow-xl border border-slate-200/40 p-8">
      <!-- Toggle -->
      <div class="flex gap-2 mb-6 p-1 rounded-2xl bg-slate-100/60">
        <button id="loginTab" class="flex-1 py-3 rounded-xl font-semibold text-slate-800 bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] text-white shadow-sm">Login</button>
        <button id="signupTab" class="flex-1 py-3 rounded-xl font-semibold text-slate-600 hover:text-slate-800">Sign Up</button>
      </div>

      <!-- Message area -->
      <div id="messageBox" class="mb-4 rounded-xl p-3 text-sm hidden"></div>

      <!-- Forms wrapper -->
      <div>

        <!-- LOGIN FORM -->
        <div id="loginForm">
          <form id="loginFormElement" class="space-y-4" autocomplete="on">
            <div>
              <label for="loginEmail" class="block text-sm font-medium text-slate-700 mb-2">Email</label>
              <input id="loginEmail" type="email" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.15)]"
                placeholder="you@example.com" />
            </div>

            <div>
              <label for="loginPassword" class="block text-sm font-medium text-slate-700 mb-2">Password</label>
              <input id="loginPassword" type="password" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.15)]"
                placeholder="Enter your password" />
            </div>

            <div class="flex items-center justify-between text-sm">
              <label class="flex items-center gap-2 text-slate-600">
                <input type="checkbox" class="h-4 w-4 rounded border-slate-300" />
                <span>Remember me</span>
              </label>
              <a href="#" id="forgotPasswordLink" class="text-[var(--primary)] hover:underline">Forgot password?</a>
            </div>

            <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] text-white font-semibold flex items-center justify-center gap-3">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v18" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
              <span id="loginBtnText">Sign In</span>
              <svg id="loginSpinner" class="w-5 h-5 animate-spin hidden" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="white" stroke-opacity="0.25" stroke-width="3" fill="none"/><path d="M22 12a10 10 0 0 0-10-10" stroke="white" stroke-width="3" stroke-linecap="round"/></svg>
            </button>
          </form>

          <div class="relative my-6">
            <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-200/60"></div></div>
            <div class="relative flex justify-center text-sm"><span class="bg-white px-3 text-slate-500">Or continue with</span></div>
          </div>

          <button id="googleLoginBtn" class="w-full py-3 rounded-xl border border-slate-200 flex items-center justify-center gap-3 hover:shadow-sm transition">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#EA4335" d="M22.6 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#4A90E2" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#FBBC05" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span class="text-sm font-semibold text-slate-700">Continue with Google</span>
          </button>
        </div>

        <!-- SIGNUP FORM -->
        <div id="signupForm" class="hidden">
          <form id="signupFormElement" class="space-y-4" autocomplete="on">
            <div>
              <label for="signupName" class="block text-sm font-medium text-slate-700 mb-2">Full name</label>
              <input id="signupName" type="text" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.12)]"
                placeholder="Jane Doe" />
            </div>

            <div>
              <label for="signupUsername" class="block text-sm font-medium text-slate-700 mb-2">Username</label>
              <input id="signupUsername" type="text" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.12)]"
                placeholder="janedoe123" />
            </div>

            <div>
              <label for="signupEmail" class="block text-sm font-medium text-slate-700 mb-2">Email</label>
              <input id="signupEmail" type="email" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.12)]"
                placeholder="you@example.com" />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="signupPassword" class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                <input id="signupPassword" type="password" minlength="6" required
                  class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none"
                  placeholder="Min. 6 characters" />
              </div>
              <div>
                <label for="signupConfirmPassword" class="block text-sm font-medium text-slate-700 mb-2">Confirm</label>
                <input id="signupConfirmPassword" type="password" minlength="6" required
                  class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none"
                  placeholder="Repeat password" />
              </div>
            </div>

            <!-- Referral Code Field -->
            <div>
              <label for="signupReferralCode" class="block text-sm font-medium text-slate-700 mb-2">
                Referral Code <span class="text-slate-400 font-normal">(optional)</span>
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <svg class="w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                  </svg>
                </div>
                <input id="signupReferralCode" type="text"
                  class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.12)] uppercase"
                  placeholder="Enter referral code" />
              </div>
              <p id="referralCodeStatus" class="text-xs mt-1 hidden"></p>
            </div>

            <div class="flex items-start gap-2 text-sm">
              <input type="checkbox" id="termsCheckbox" class="h-4 w-4 rounded border-slate-300 mt-1" required />
              <label for="termsCheckbox" class="text-slate-600">I agree to the <a href="#" class="text-[var(--primary)] hover:underline">Terms</a> and <a href="#" class="text-[var(--primary)] hover:underline">Privacy</a>.</label>
            </div>

            <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] text-white font-semibold flex items-center justify-center gap-3">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M3 12h18" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
              <span id="signupBtnText">Create account</span>
              <svg id="signupSpinner" class="w-5 h-5 animate-spin hidden" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="white" stroke-opacity="0.25" stroke-width="3" fill="none"/><path d="M22 12a10 10 0 0 0-10-10" stroke="white" stroke-width="3" stroke-linecap="round"/></svg>
            </button>
          </form>

          <div class="relative my-6">
            <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-200/60"></div></div>
            <div class="relative flex justify-center text-sm"><span class="bg-white px-3 text-slate-500">Or continue with</span></div>
          </div>

          <button id="googleSignupBtn" class="w-full py-3 rounded-xl border border-slate-200 flex items-center justify-center gap-3 hover:shadow-sm transition">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#EA4335" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#4A90E2" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#FBBC05" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span class="text-sm font-semibold text-slate-700">Continue with Google</span>
          </button>
        </div>

      </div>
    </div>

    <div class="text-center mt-6 text-sm text-slate-500">
      <a href="/" class="hover:text-slate-700 transition">‚Üê Back to Home</a>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDsZ2luMQAqmnwk0y6-vJ1gzKkMd1NKFuc",
    authDomain: "timora-2680a.firebaseapp.com",
    projectId: "timora-2680a",
    storageBucket: "timora-2680a.firebasestorage.app",
    messagingSenderId: "1036436572315",
    appId: "1:1036436572315:web:58b1ecb4cb84045aaa5e3e"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // FLAG TO PREVENT AUTO-REDIRECT DURING GOOGLE SIGNUP
  let isProcessingGoogleAuth = false;

  const REFERRAL_CONFIG = {
    coinsPerReferral: 100,
    bonusForFriend: 50
  };

  function showMessage(message, type='info') {
    const box = document.getElementById('messageBox');
    box.className = 'rounded-xl p-3 text-sm mb-4';
    if (type === 'error') {
      box.classList.add('bg-red-50','text-red-700','border','border-red-100');
    } else if (type === 'success') {
      box.classList.add('bg-green-50','text-green-700','border','border-green-100');
    } else {
      box.classList.add('bg-blue-50','text-slate-700','border','border-blue-100');
    }
    box.textContent = message;
    box.classList.remove('hidden');
    setTimeout(() => box.classList.add('hidden'), 6000);
  }

  function generateAvatar(email) {
    const seeds = ['adventurer','avataaars','bottts','fun-emoji'];
    const style = seeds[Math.floor(Math.random()*seeds.length)];
    return `https://api.dicebear.com/7.x/${style}/svg?seed=${encodeURIComponent(email)}`;
  }

  function generateReferralCode(uid) {
    const prefix = 'TIM';
    const suffix = uid.substring(0, 6).toUpperCase();
    const random = Math.random().toString(36).substring(2, 5).toUpperCase();
    return `${prefix}${suffix}${random}`;
  }

  function getTodayDate() {
    return new Date().toISOString().split('T')[0];
  }

  function getReferralCodeFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('ref')?.toUpperCase() || params.get('referral')?.toUpperCase() || '';
  }

  // ============================================
  // TAB ELEMENTS
  // ============================================
  const loginTab = document.getElementById('loginTab');
  const signupTab = document.getElementById('signupTab');
  const loginForm = document.getElementById('loginForm');
  const signupForm = document.getElementById('signupForm');

  loginTab.addEventListener('click', () => {
    loginTab.classList.add('bg-gradient-to-r','from-[var(--primary)]','to-[var(--secondary)]','text-white');
    signupTab.classList.remove('bg-gradient-to-r','from-[var(--primary)]','to-[var(--secondary)]','text-white');
    signupTab.classList.add('text-slate-600');
    loginForm.classList.remove('hidden');
    signupForm.classList.add('hidden');
  });

  signupTab.addEventListener('click', () => {
    signupTab.classList.add('bg-gradient-to-r','from-[var(--primary)]','to-[var(--secondary)]','text-white');
    loginTab.classList.remove('bg-gradient-to-r','from-[var(--primary)]','to-[var(--secondary)]','text-white');
    loginTab.classList.add('text-slate-800');
    signupForm.classList.remove('hidden');
    loginForm.classList.add('hidden');
  });

  // ============================================
  // REFERRAL INPUT AUTO-UPPERCASE
  // ============================================
  const referralCodeInput = document.getElementById('signupReferralCode');
  if (referralCodeInput) {
    referralCodeInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });
  }

  // ============================================
  // INIT REFERRAL FROM URL
  // ============================================
  function initReferralFromURL() {
    const refCode = getReferralCodeFromURL();
    if (refCode) {
      const referralInput = document.getElementById('signupReferralCode');
      if (referralInput) referralInput.value = refCode;
      
      const banner = document.getElementById('referralBanner');
      if (banner) banner.classList.remove('hidden');
      
      const bonusEl = document.getElementById('bonusAmount');
      if (bonusEl) bonusEl.textContent = REFERRAL_CONFIG.bonusForFriend;
      
      setTimeout(() => signupTab?.click(), 300);
      console.log('Referral code from URL:', refCode);
    }
  }

  // ============================================
  // EMAIL/PASSWORD LOGIN
  // ============================================
  document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const btnText = document.getElementById('loginBtnText');
    const spinner = document.getElementById('loginSpinner');

    btnText.textContent = 'Signing in...';
    spinner.classList.remove('hidden');

    try {
  const cred = await auth.signInWithEmailAndPassword(email, password);
  if (!cred.user.emailVerified) {
    showMessage('Please verify your email before signing in.', 'info');
    await auth.signOut();
    btnText.textContent = 'Sign In';
    spinner.classList.add('hidden');
    return;
  }
  
  // SET FLAG FOR AUTH STATE LISTENER
  window.sessionStorage.setItem('justLoggedIn', 'true');
  
  showMessage('Login successful ‚Äî redirecting...', 'success');
  setTimeout(() => window.location.href = 'dashboard.html', 900);
} catch (err) {
  console.error(err);
  showMessage(err.message || 'Login error', 'error');
  btnText.textContent = 'Sign In';
  spinner.classList.add('hidden');
}
  });

  // ============================================
  // EMAIL/PASSWORD SIGNUP
  // ============================================
  document.getElementById('signupFormElement').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('signupName').value.trim();
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirm = document.getElementById('signupConfirmPassword').value;
    const referralCode = document.getElementById('signupReferralCode')?.value?.trim()?.toUpperCase() || '';
    const btnText = document.getElementById('signupBtnText');
    const spinner = document.getElementById('signupSpinner');

    if (password !== confirm) { 
      showMessage('Passwords do not match', 'error'); 
      return; 
    }

    if (!username) {
      showMessage('Please enter a username', 'error');
      return;
    }

    btnText.textContent = 'Creating...';
    spinner.classList.remove('hidden');

    try {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      const user = cred.user;
      const avatarUrl = generateAvatar(email);
      
      await user.updateProfile({ displayName: name, photoURL: avatarUrl });
      await user.sendEmailVerification();

      const newUserReferralCode = generateReferralCode(user.uid);

      // COINS: 60 IF REFERRAL, 10 IF NOT
      const coins = referralCode ? 60 : 10;

      await db.collection('users').doc(user.uid).set({
        uid: user.uid,
        name: name,
        username: username,
        email: email,
        logoUrl: avatarUrl,
        photoURL: avatarUrl,
        coins: coins,
        subscription: 'Free',
        totalFocusMinutes: 0,
        totalFocusHours: 0,
        totalSessions: 0,
        currentStreak: 0,
        bestStreak: 0,
        lastActiveDate: getTodayDate(),
        level: 1,
        xp: 0,
        referralCode: newUserReferralCode,
        referredBy: referralCode || null,
        referralStats: { totalReferrals: 0, pendingReferrals: 0, coinsEarned: 0 },
        water: { cups: 0, goal: 8, lastUpdated: getTodayDate() },
        pomSettings: { focus: 25, short: 5, long: 15, soundType: 'chime', notifications: true, sessionsBeforeLong: 4, autoStart: false },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      await db.collection('referralCodes').doc(newUserReferralCode).set({
        userId: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

     // GIVE 100 COINS TO REFERRER + CREATE HISTORY ENTRY
if (referralCode) {
  try {
    const codeDoc = await db.collection('referralCodes').doc(referralCode).get();
    if (codeDoc.exists) {
      const referrerId = codeDoc.data().userId;
      if (referrerId && referrerId !== user.uid) {
        // Give 100 coins + update stats
        await db.collection('users').doc(referrerId).update({
          coins: firebase.firestore.FieldValue.increment(100),
          'referralStats.totalReferrals': firebase.firestore.FieldValue.increment(1),
          'referralStats.coinsEarned': firebase.firestore.FieldValue.increment(100)
        });
        
        // CREATE REFERRAL HISTORY ENTRY
        await db.collection('users').doc(referrerId).collection('referrals').add({
          referredUserId: user.uid,
          referredName: name || email || 'New User',
          coinsEarned: 100,
          status: 'completed',
          timestamp: Date.now(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Gave 100 coins to referrer + created history entry');
      }
    }
  } catch (refErr) {
    console.log('Referrer bonus failed:', refErr);
  }
}

      await auth.signOut();
      
      if (referralCode) {
        showMessage('üéâ Account created with 50 bonus coins! Check email & login.', 'success');
      } else {
        showMessage('Account created! Check email for verification.', 'success');
      }
      
      setTimeout(() => loginTab.click(), 1200);
      
    } catch (err) {
      console.error(err);
      showMessage(err.message || 'Signup error', 'error');
    } finally {
      btnText.textContent = 'Create account';
      spinner.classList.add('hidden');
    }
  });

  // ============================================
  // GOOGLE AUTH ‚Äî THE FINAL FIX
  // ============================================
 async function handleGoogleAuth() {
  // SET FLAG TO PREVENT AUTO-REDIRECT
  isProcessingGoogleAuth = true;
  
  const hasReferral = window.location.search.includes('ref=') || window.location.search.includes('referral=');
  const refCode = getReferralCodeFromURL();
  
  // FORCE GOOGLE TO SHOW ACCOUNT PICKER EVERY TIME
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({
    prompt: 'select_account'
  });
  
  console.log('=== GOOGLE AUTH START ===');
  console.log('Has referral:', hasReferral);
  console.log('Ref code:', refCode);

  try {
    const result = await auth.signInWithPopup(provider);
    const user = result.user;
    
    console.log('Google user:', user.uid, user.email);

    const userRef = db.collection('users').doc(user.uid);
    const snap = await userRef.get();
    
    console.log('User exists in Firestore:', snap.exists);

    if (!snap.exists) {
      // NEW USER
      const coins = hasReferral ? 60 : 10;
      console.log('NEW USER - Setting coins to:', coins);

      await userRef.set({
        uid: user.uid,
        name: user.displayName || 'User',
        email: user.email,
        photoURL: user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`,
        coins: coins,
        subscription: 'Free',
        totalFocusMinutes: 0,
        totalFocusHours: 0,
        totalSessions: 0,
        currentStreak: 0,
        bestStreak: 0,
        lastActiveDate: getTodayDate(),
        level: 1,
        xp: 0,
        referralCode: generateReferralCode(user.uid),
        referredBy: refCode || null,
        referralStats: { totalReferrals: 0, pendingReferrals: 0, coinsEarned: 0 },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      console.log('User document created with', coins, 'coins');

      // GIVE 100 COINS TO REFERRER + CREATE HISTORY ENTRY
      if (refCode) {
        try {
          const codeDoc = await db.collection('referralCodes').doc(refCode).get();
          if (codeDoc.exists) {
            const referrerId = codeDoc.data().userId;
            if (referrerId && referrerId !== user.uid) {
              // Give 100 coins + update stats
              await db.collection('users').doc(referrerId).update({
                coins: firebase.firestore.FieldValue.increment(100),
                'referralStats.totalReferrals': firebase.firestore.FieldValue.increment(1),
                'referralStats.coinsEarned': firebase.firestore.FieldValue.increment(100)
              });
              
              // CREATE REFERRAL HISTORY ENTRY (SHOWS IN DASHBOARD)
              await db.collection('users').doc(referrerId).collection('referrals').add({
                referredUserId: user.uid,
                referredName: user.displayName || user.email || 'New User',
                coinsEarned: 100,
                status: 'completed',
                timestamp: Date.now(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              console.log('‚úÖ Gave 100 coins to referrer + created history entry');
            }
          }
        } catch (refErr) {
          console.log('Referrer bonus failed:', refErr);
        }
      }

      // SIGN OUT
      await auth.signOut();
      console.log('User signed out after account creation');
      
      // SHOW MESSAGE
      if (hasReferral) {
        showMessage('üéâ Account created with 50 bonus coins! Now login with Google.', 'success');
      } else {
        showMessage('Account created! Now login with Google.', 'success');
      }
      
      // SWITCH TO LOGIN TAB
      setTimeout(() => {
        loginTab.click();
        isProcessingGoogleAuth = false;
      }, 1000);
      
    } else {
  // EXISTING USER ‚Äî GO TO DASHBOARD
  console.log('Existing user, redirecting to dashboard');
  
  // SET FLAG FOR AUTH STATE LISTENER
  window.sessionStorage.setItem('justLoggedIn', 'true');
  
  isProcessingGoogleAuth = false;
  window.location.href = 'dashboard.html';
}
    
  } catch (e) {
    console.error('Google auth error:', e);
    showMessage('Google sign-in failed. Try again.', 'error');
    isProcessingGoogleAuth = false;
  }
}

  // Attach to both Google buttons
  document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleAuth);
  document.getElementById('googleSignupBtn').addEventListener('click', handleGoogleAuth);

  // ============================================
  // FORGOT PASSWORD
  // ============================================
  document.getElementById('forgotPasswordLink').addEventListener('click', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    if (!email) { 
      showMessage('Enter your email to receive reset link', 'info'); 
      return; 
    }
    try {
      await auth.sendPasswordResetEmail(email);
      showMessage('Password reset sent ‚Äî check your inbox', 'success');
    } catch (err) {
      showMessage(err.message || 'Reset failed', 'error');
    }
  });

  // ============================================
  // AUTH STATE ‚Äî WITH FLAG CHECK
  // ============================================
  // ============================================
// AUTH STATE ‚Äî WITH FLAG CHECK
// ============================================
auth.onAuthStateChanged((user) => {
  // DON'T REDIRECT IF WE'RE PROCESSING GOOGLE AUTH
  if (isProcessingGoogleAuth) {
    console.log('Skipping auto-redirect (processing Google auth)');
    return;
  }
  
  // ONLY redirect if user explicitly just logged in
  // NOT on page load (which would interrupt the loading screen)
  if (user && window.sessionStorage.getItem('justLoggedIn')) {
    const isGoogleUser = user.providerData.some(p => p.providerId === 'google.com');
    
    if (isGoogleUser || user.emailVerified) {
      console.log('Redirecting after successful login');
      window.sessionStorage.removeItem('justLoggedIn');
      window.location.href = 'dashboard.html';
    }
  }
});

  // INIT
  initReferralFromURL();
  console.log('Login page ready');
</script>z
</body>
</html>
