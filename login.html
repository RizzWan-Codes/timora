<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Timora ‚Äî Login</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #8b5cf6;
      --secondary: #ec4899;
      --accent: #06b6d4;
    }
    body { font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .orb {
      position: absolute;
      border-radius: 9999px;
      filter: blur(80px);
      opacity: 0.45;
      transform: translate3d(0,0,0);
      z-index: 0;
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
      50% { box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); }
    }
    
    .referral-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-800 flex items-center justify-center p-6">

  <!-- Floating gradient orbs -->
  <div class="orb" style="width:380px;height:380px;background:linear-gradient(135deg,var(--primary),var(--secondary)); top:-120px; left:-120px;"></div>
  <div class="orb" style="width:460px;height:460px;background:linear-gradient(135deg,var(--secondary),#06b6d4); bottom:-160px; right:-160px; opacity:0.35;"></div>
  <div class="orb" style="width:300px;height:300px;background:linear-gradient(135deg,var(--primary),#60a5fa); top:45%; left:50%; transform:translate(-30%, -40%); opacity:0.18;"></div>

  <!-- Main card -->
  <div class="relative z-10 w-full max-w-lg">
    <!-- Logo + heading -->
    <div class="mb-8 text-center">
      <a href="/" class="inline-flex items-center gap-3">
        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-[rgba(139,92,246,1)] to-[rgba(236,72,153,1)] flex items-center justify-center shadow-lg">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 7.5L12 3l9 4.5v9L12 21 3 16.5v-9z" fill="white" opacity="0.95"/>
            <path d="M12 3v18" stroke="white" stroke-opacity="0.08" stroke-width="1.5"/>
          </svg>
        </div>
        <span class="text-2xl font-semibold tracking-tight">Timora</span>
      </a>
      <p class="mt-2 text-sm text-slate-500">Plan smarter. Study better.</p>
    </div>

    <!-- Referral Banner (shown when ref code exists) -->
    <div id="referralBanner" class="hidden mb-6 p-4 rounded-2xl bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 referral-glow">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center text-2xl flex-shrink-0">
          üéÅ
        </div>
        <div class="flex-1">
          <div class="font-semibold text-emerald-800">You've been invited!</div>
          <div class="text-sm text-emerald-600">Sign up to receive <span id="bonusAmount" class="font-bold">50</span> bonus coins</div>
        </div>
        <div class="text-emerald-500">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Card -->
    <div class="bg-white/80 backdrop-blur rounded-3xl shadow-xl border border-slate-200/40 p-8">
      <!-- Toggle -->
      <div class="flex gap-2 mb-6 p-1 rounded-2xl bg-slate-100/60">
        <button id="loginTab" class="flex-1 py-3 rounded-xl font-semibold text-slate-800 bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] text-white shadow-sm">Login</button>
        <button id="signupTab" class="flex-1 py-3 rounded-xl font-semibold text-slate-600 hover:text-slate-800">Sign Up</button>
      </div>

      <!-- Message area -->
      <div id="messageBox" class="mb-4 rounded-xl p-3 text-sm hidden"></div>

      <!-- Forms wrapper -->
      <div>

        <!-- LOGIN FORM -->
        <div id="loginForm">
          <form id="loginFormElement" class="space-y-4" autocomplete="on">
            <div>
              <label for="loginEmail" class="block text-sm font-medium text-slate-700 mb-2">Email</label>
              <input id="loginEmail" type="email" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.15)]"
                placeholder="you@example.com" />
            </div>

            <div>
              <label for="loginPassword" class="block text-sm font-medium text-slate-700 mb-2">Password</label>
              <input id="loginPassword" type="password" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.15)]"
                placeholder="Enter your password" />
            </div>

            <div class="flex items-center justify-between text-sm">
              <label class="flex items-center gap-2 text-slate-600">
                <input type="checkbox" class="h-4 w-4 rounded border-slate-300" />
                <span>Remember me</span>
              </label>
              <a href="#" id="forgotPasswordLink" class="text-[var(--primary)] hover:underline">Forgot password?</a>
            </div>

            <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] text-white font-semibold flex items-center justify-center gap-3">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v18" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
              <span id="loginBtnText">Sign In</span>
              <svg id="loginSpinner" class="w-5 h-5 animate-spin hidden" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="white" stroke-opacity="0.25" stroke-width="3" fill="none"/><path d="M22 12a10 10 0 0 0-10-10" stroke="white" stroke-width="3" stroke-linecap="round"/></svg>
            </button>
          </form>

          <div class="relative my-6">
            <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-200/60"></div></div>
            <div class="relative flex justify-center text-sm"><span class="bg-white px-3 text-slate-500">Or continue with</span></div>
          </div>

          <button id="googleLoginBtn" class="w-full py-3 rounded-xl border border-slate-200 flex items-center justify-center gap-3 hover:shadow-sm transition">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#EA4335" d="M22.6 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#4A90E2" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#FBBC05" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span class="text-sm font-semibold text-slate-700">Continue with Google</span>
          </button>
        </div>

        <!-- SIGNUP FORM -->
        <div id="signupForm" class="hidden">
          <form id="signupFormElement" class="space-y-4" autocomplete="on">
            <div>
              <label for="signupName" class="block text-sm font-medium text-slate-700 mb-2">Full name</label>
              <input id="signupName" type="text" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.12)]"
                placeholder="Jane Doe" />
            </div>

            <div>
              <label for="signupUsername" class="block text-sm font-medium text-slate-700 mb-2">Username</label>
              <input id="signupUsername" type="text" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.12)]"
                placeholder="janedoe123" />
            </div>

            <div>
              <label for="signupEmail" class="block text-sm font-medium text-slate-700 mb-2">Email</label>
              <input id="signupEmail" type="email" required
                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.12)]"
                placeholder="you@example.com" />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="signupPassword" class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                <input id="signupPassword" type="password" minlength="6" required
                  class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none"
                  placeholder="Min. 6 characters" />
              </div>
              <div>
                <label for="signupConfirmPassword" class="block text-sm font-medium text-slate-700 mb-2">Confirm</label>
                <input id="signupConfirmPassword" type="password" minlength="6" required
                  class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none"
                  placeholder="Repeat password" />
              </div>
            </div>

            <!-- Referral Code Field -->
            <div>
              <label for="signupReferralCode" class="block text-sm font-medium text-slate-700 mb-2">
                Referral Code <span class="text-slate-400 font-normal">(optional)</span>
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <svg class="w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                  </svg>
                </div>
                <input id="signupReferralCode" type="text"
                  class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[rgba(139,92,246,0.12)] uppercase"
                  placeholder="Enter referral code" />
              </div>
              <p id="referralCodeStatus" class="text-xs mt-1 hidden"></p>
            </div>

            <div class="flex items-start gap-2 text-sm">
              <input type="checkbox" id="termsCheckbox" class="h-4 w-4 rounded border-slate-300 mt-1" required />
              <label for="termsCheckbox" class="text-slate-600">I agree to the <a href="#" class="text-[var(--primary)] hover:underline">Terms</a> and <a href="#" class="text-[var(--primary)] hover:underline">Privacy</a>.</label>
            </div>

            <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] text-white font-semibold flex items-center justify-center gap-3">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M3 12h18" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
              <span id="signupBtnText">Create account</span>
              <svg id="signupSpinner" class="w-5 h-5 animate-spin hidden" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="white" stroke-opacity="0.25" stroke-width="3" fill="none"/><path d="M22 12a10 10 0 0 0-10-10" stroke="white" stroke-width="3" stroke-linecap="round"/></svg>
            </button>
          </form>

          <div class="relative my-6">
            <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-200/60"></div></div>
            <div class="relative flex justify-center text-sm"><span class="bg-white px-3 text-slate-500">Or continue with</span></div>
          </div>

          <button id="googleSignupBtn" class="w-full py-3 rounded-xl border border-slate-200 flex items-center justify-center gap-3 hover:shadow-sm transition">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#EA4335" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#4A90E2" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#FBBC05" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span class="text-sm font-semibold text-slate-700">Continue with Google</span>
          </button>
        </div>

      </div>
    </div>

    <div class="text-center mt-6 text-sm text-slate-500">
      <a href="/" class="hover:text-slate-700 transition">‚Üê Back to Home</a>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDsZ2luMQAqmnwk0y6-vJ1gzKkMd1NKFuc",
    authDomain: "timora-2680a.firebaseapp.com",
    projectId: "timora-2680a",
    storageBucket: "timora-2680a.firebasestorage.app",
    messagingSenderId: "1036436572315",
    appId: "1:1036436572315:web:58b1ecb4cb84045aaa5e3e"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let isProcessingGoogleAuth = false;

  const REFERRAL_CONFIG = {
    coinsPerReferral: 100,
    bonusForFriend: 50
  };

  // Keep all your utility functions like showMessage, generateAvatar, etc.
  function showMessage(msg, type='info') { /* ... */ }
  function generateAvatar(email) { /* ... */ }
  function generateReferralCode(uid) { /* ... */ }
  function getTodayDate() { /* ... */ }
  function getReferralCodeFromURL() { const p = new URLSearchParams(window.location.search); return (p.get('ref')||p.get('referral')||'').toUpperCase(); }
  
  // Keep tab switching logic
  const loginTab = document.getElementById('loginTab'), signupTab = document.getElementById('signupTab');
  const loginForm = document.getElementById('loginForm'), signupForm = document.getElementById('signupForm');
  loginTab.addEventListener('click',() => { /* ... */ });
  signupTab.addEventListener('click',() => { /* ... */ });

  // Keep referral input logic
  const referralCodeInput = document.getElementById('signupReferralCode');
  if (referralCodeInput) { referralCodeInput.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase()); }

  // Keep Email/Password Login logic
  document.getElementById('loginFormElement').addEventListener('submit', async (e) => { /* ... */ });

  // ==========================================================
  // UPDATED PROCESS REFERRAL FUNCTION (Client-Side)
  // ==========================================================
  async function processReferral(refCode, newUserId, newUserName) {
    if (!refCode) return;
    
    console.log('Processing referral for code:', refCode);
    
    try {
      const codeDoc = await db.collection('referralCodes').doc(refCode).get();
      if (!codeDoc.exists) {
        console.warn('Referral code not found:', refCode);
        return;
      }
      
      const referrerId = codeDoc.data().userId;
      if (referrerId === newUserId) {
        console.warn('Self-referral blocked.');
        return;
      }
      
      const batch = db.batch();
      const referrerRef = db.collection('users').doc(referrerId);
      
      // Update referrer's coins and stats
      batch.update(referrerRef, {
        coins: firebase.firestore.FieldValue.increment(REFERRAL_CONFIG.coinsPerReferral),
        'referralStats.totalReferrals': firebase.firestore.FieldValue.increment(1),
        'referralStats.coinsEarned': firebase.firestore.FieldValue.increment(REFERRAL_CONFIG.coinsPerReferral)
      });
      
      // Create history entry in referrer's subcollection
      const historyRef = referrerRef.collection('referrals').doc();
      batch.set(historyRef, {
        referredUserId: newUserId,
        referredName: newUserName || 'New User',
        coinsEarned: REFERRAL_CONFIG.coinsPerReferral,
        status: 'completed',
        timestamp: Date.now()
      });
      
      await batch.commit();
      console.log(`‚úÖ Success! Gave ${REFERRAL_CONFIG.coinsPerReferral} coins to referrer ${referrerId}`);
      
    } catch (err) {
      console.error('CRITICAL: Failed to process referral:', err);
    }
  }

  // ==========================================================
  // UPDATED GOOGLE AUTH FUNCTION
  // ==========================================================
  async function handleGoogleAuth() {
    isProcessingGoogleAuth = true;
    const refCode = getReferralCodeFromURL();
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    
    try {
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      const userRef = db.collection('users').doc(user.uid);
      const snap = await userRef.get();

      if (!snap.exists()) {
        const hasReferral = !!refCode;
        const coins = hasReferral ? 60 : 10;
        
        await userRef.set({
          uid: user.uid,
          name: user.displayName || 'User',
          email: user.email,
          photoURL: user.photoURL || generateAvatar(user.email),
          coins: coins,
          subscription: 'Free',
          referralCode: generateReferralCode(user.uid),
          referredBy: refCode || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
          // ... add all other user fields here
        });

        // PROCESS REFERRAL DIRECTLY
        if (hasReferral) {
          await processReferral(refCode, user.uid, user.displayName);
        }
        
        await auth.signOut();
        showMessage('Account created! Login with Google to continue.', 'success');
        setTimeout(() => {
          loginTab.click();
          isProcessingGoogleAuth = false;
        }, 1000);

      } else {
        isProcessingGoogleAuth = false;
        location.href = 'dashboard.html';
      }
    } catch (e) {
      isProcessingGoogleAuth = false;
      showMessage('Google sign-in failed. Try again.', 'error');
    }
  }

  // ==========================================================
  // UPDATED EMAIL/PASSWORD SIGNUP
  // ==========================================================
  document.getElementById('signupFormElement').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const refCode = getReferralCodeFromURL() || document.getElementById('signupReferralCode').value.trim().toUpperCase();

    // ... (rest of validation)

    try {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      const user = cred.user;

      const hasReferral = !!refCode;
      const coins = hasReferral ? 60 : 10;
      
      await db.collection('users').doc(user.uid).set({
        uid: user.uid,
        name: name,
        email: email,
        photoURL: generateAvatar(email),
        coins: coins,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
        // ... add all other user fields
      });

      // PROCESS REFERRAL DIRECTLY
      if (hasReferral) {
        await processReferral(refCode, user.uid, name);
      }
      
      await user.sendEmailVerification();
      await auth.signOut();

      showMessage('Account created! Check your email to verify, then login.', 'success');
      setTimeout(() => loginTab.click(), 1000);

    } catch (err) {
      showMessage(err.message, 'error');
    }
  });

  // Attach handlers, auth state listener, and init
  document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleAuth);
  document.getElementById('googleSignupBtn').addEventListener('click', handleGoogleAuth);
  document.getElementById('forgotPasswordLink').addEventListener('click', async (e) => { /* ... */ });
  auth.onAuthStateChanged((user) => { if (!isProcessingGoogleAuth && user) location.href = 'dashboard.html'; });
  initReferralFromURL();
</script>
</body>
</html>
